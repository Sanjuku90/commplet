
{% extends "base.html" %}

{% block content %}
<style>
    /* Variables CSS personnalis√©es */
    :root {
        --primary-blue: #3b82f6;
        --primary-purple: #8b5cf6;
        --success-green: #10b981;
        --warning-orange: #f59e0b;
        --danger-red: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
    }

    /* Container principal mobile-first */
    .dashboard-container {
        max-width: 100%;
        padding: 0.75rem;
        background: #f8fafc;
        min-height: 100vh;
    }

    /* Header moderne */
    .welcome-header {
        background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        color: white;
        box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        position: relative;
        overflow: hidden;
    }

    .welcome-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(255,255,255,0.1), transparent);
        border-radius: 50%;
    }

    .welcome-content {
        position: relative;
        z-index: 1;
    }

    .welcome-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .welcome-subtitle {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0;
    }

    .kyc-status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1rem;
    }

    .kyc-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .kyc-badge.verified {
        background: rgba(255, 255, 255, 0.2);
        color: #dcfce7;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .kyc-badge.pending {
        background: rgba(251, 191, 36, 0.2);
        color: #fef3c7;
        border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .kyc-badge.unverified {
        background: rgba(239, 68, 68, 0.2);
        color: #fee2e2;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Grille de statistiques mobile */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card-mobile {
        background: white;
        border-radius: 16px;
        padding: 1.25rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--gray-100);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card-mobile::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-blue), var(--primary-purple));
    }

    .stat-card-mobile:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .stat-header {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.75rem;
        font-size: 16px;
        color: white;
    }

    .stat-icon.balance {
        background: linear-gradient(135deg, var(--success-green), #059669);
    }

    .stat-icon.investments {
        background: linear-gradient(135deg, var(--primary-blue), #1d4ed8);
    }

    .stat-icon.profits {
        background: linear-gradient(135deg, var(--primary-purple), #7c3aed);
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
        line-height: 1.1;
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--gray-500);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .stat-indicator {
        font-size: 0.75rem;
        margin-top: 0.5rem;
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
        background: var(--gray-50);
        color: var(--gray-600);
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .stat-indicator.positive {
        background: #dcfce7;
        color: #059669;
    }

    /* Section Actions rapides */
    .actions-section {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--gray-100);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .actions-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .action-button {
        background: linear-gradient(135deg, var(--success-green), #059669);
        border: none;
        border-radius: 16px;
        padding: 1.25rem;
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
    }

    .action-button.withdraw {
        background: linear-gradient(135deg, var(--primary-blue), #1d4ed8);
    }

    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .action-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .action-button:hover::before {
        left: 100%;
    }

    .action-content {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
    }

    .action-icon {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .action-text {
        flex: 1;
    }

    .action-title {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .action-subtitle {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .action-arrow {
        font-size: 1.2rem;
        opacity: 0.7;
    }

    /* Section Investissements */
    .investments-section {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--gray-100);
    }

    .investment-card {
        background: linear-gradient(135deg, var(--gray-50), white);
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid var(--gray-200);
        transition: all 0.3s ease;
        position: relative;
    }

    .investment-card:last-child {
        margin-bottom: 0;
    }

    .investment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .investment-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .investment-title {
        font-size: 1rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }

    .investment-amount {
        font-size: 0.85rem;
        color: var(--gray-600);
    }

    .status-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }

    .status-badge.active {
        background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        color: #065f46;
    }

    .status-badge.completed {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        color: #1e40af;
    }

    .investment-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .investment-stat {
        background: white;
        padding: 0.875rem;
        border-radius: 12px;
        border: 1px solid var(--gray-100);
        text-align: center;
    }

    .investment-stat-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        margin-bottom: 0.25rem;
    }

    .investment-stat-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .investment-stat-value.profit {
        color: var(--success-green);
    }

    .investment-stat-value.earnings {
        color: var(--primary-blue);
    }

    .live-earnings-indicator {
        background: #dcfce7;
        padding: 0.5rem;
        border-radius: 8px;
        border: 1px solid #bbf7d0;
        text-align: center;
        margin-top: 0.75rem;
    }

    .live-earnings-text {
        font-size: 0.75rem;
        color: #065f46;
        font-weight: 600;
    }

    .investment-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--gray-100);
    }

    .investment-date {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    /* √âtat vide */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        background: linear-gradient(135deg, var(--gray-50), white);
        border-radius: 20px;
        border: 1px solid var(--gray-100);
    }

    .empty-icon {
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        margin: 0 auto 1.5rem;
    }

    .empty-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
        margin-bottom: 0.75rem;
    }

    .empty-description {
        color: var(--gray-600);
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .empty-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .btn-primary, .btn-secondary, .btn-warning {
        padding: 0.875rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
        background: white;
        color: var(--gray-700);
        border: 2px solid var(--gray-200);
    }

    .btn-secondary:hover {
        background: var(--gray-50);
        border-color: var(--primary-blue);
        color: var(--primary-blue);
        transform: translateY(-1px);
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning-orange), #d97706);
        color: white;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
    }

    /* Modales */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .modal.hidden {
        display: none;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--gray-900);
    }

    .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--gray-100);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--gray-600);
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: var(--gray-200);
        color: var(--gray-800);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--gray-200);
        border-radius: 12px;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: var(--gray-50);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        background: white;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    .info-box {
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        border: 1px solid;
    }

    .info-box.warning {
        background: #fef3c7;
        border-color: #fbbf24;
        color: #92400e;
    }

    .info-box.info {
        background: #dbeafe;
        border-color: #60a5fa;
        color: #1e40af;
    }

    .copy-button {
        background: var(--primary-blue);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 0.5rem;
    }

    .copy-button:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }

    .deposit-address {
        background: white;
        padding: 0.75rem;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.8rem;
        word-break: break-all;
        border: 1px solid #fbbf24;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .deposit-address:hover {
        background: #fef3c7;
    }

    /* Zone de notifications mobile */
    .notifications-container {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
        width: calc(100% - 2rem);
        max-width: 400px;
        pointer-events: none;
    }

    .notification-mobile {
        background: white;
        border-radius: 16px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        border-left: 4px solid;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideInDown 0.4s ease-out;
        pointer-events: auto;
        position: relative;
        overflow: hidden;
    }

    .notification-mobile.success {
        border-left-color: var(--success-green);
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
    }

    .notification-mobile.error {
        border-left-color: var(--danger-red);
        background: linear-gradient(135deg, #fef2f2, #fee2e2);
    }

    .notification-mobile.info {
        border-left-color: var(--primary-blue);
        background: linear-gradient(135deg, #eff6ff, #dbeafe);
    }

    .notification-mobile.warning {
        border-left-color: var(--warning-orange);
        background: linear-gradient(135deg, #fffbeb, #fef3c7);
    }

    .notification-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        flex-shrink: 0;
    }

    .notification-icon.success {
        background: var(--success-green);
    }

    .notification-icon.error {
        background: var(--danger-red);
    }

    .notification-icon.info {
        background: var(--primary-blue);
    }

    .notification-icon.warning {
        background: var(--warning-orange);
    }

    .notification-content {
        flex: 1;
        min-width: 0;
    }

    .notification-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }

    .notification-message {
        font-size: 0.85rem;
        color: var(--gray-600);
        line-height: 1.4;
    }

    .notification-close {
        width: 24px;
        height: 24px;
        border: none;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--gray-500);
        font-size: 12px;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .notification-close:hover {
        background: rgba(0, 0, 0, 0.2);
        color: var(--gray-700);
    }

    .notification-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0 0 16px 16px;
        animation: progressBar 5s linear forwards;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideOutUp {
        from {
            opacity: 1;
            transform: translateY(0);
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
        }
    }

    @keyframes progressBar {
        from {
            width: 100%;
        }
        to {
            width: 0%;
        }
    }

    /* Responsive Design */
    @media (min-width: 640px) {
        .dashboard-container {
            padding: 1.5rem;
        }

        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
        }

        .actions-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .investment-stats {
            grid-template-columns: repeat(3, 1fr);
        }

        .empty-actions {
            flex-direction: row;
            justify-content: center;
        }
    }

    @media (min-width: 1024px) {
        .dashboard-container {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
    }

    /* Animations */
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    .realtime-earnings {
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeInUp 0.6s ease-out;
    }
</style>

<div class="dashboard-container">
    <!-- Header de bienvenue -->
    <div class="welcome-header fade-in">
        <div class="welcome-content">
            <h1 class="welcome-title">
                üëã Salut {{ user.first_name or 'Utilisateur' }}!
            </h1>
            <p class="welcome-subtitle">Voici ton tableau de bord d'investissement</p>
            
            <div class="kyc-status-header">
                <div>
                    <span class="text-sm">Statut KYC</span>
                </div>
                <span class="kyc-badge {{ 'verified' if user.kyc_status == 'approved' else 'pending' if user.kyc_status == 'pending' else 'unverified' }}">
                    {% if user.kyc_status == 'approved' %}
                        <i class="fas fa-check-circle"></i>V√©rifi√©
                    {% elif user.kyc_status == 'pending' %}
                        <i class="fas fa-clock"></i>En cours
                    {% else %}
                        <i class="fas fa-exclamation-triangle"></i>Non v√©rifi√©
                    {% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Statistiques principales -->
    <div class="stats-grid fade-in">
        <div class="stat-card-mobile">
            <div class="stat-header">
                <div class="stat-icon balance">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value" id="main-balance" data-base-balance="{{ user.balance }}">
                        {{ "%.2f"|format(user.balance) }}
                    </div>
                    <div class="stat-label">USDT disponible</div>
                </div>
            </div>
            <div class="stat-indicator positive">
                üíö Pr√™t √† investir
                <span id="balance-indicator"></span>
            </div>
        </div>

        <div class="stat-card-mobile">
            <div class="stat-header">
                <div class="stat-icon investments">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">{{ investments|length }}</div>
                    <div class="stat-label">Plans actifs</div>
                </div>
            </div>
            <div class="stat-indicator">
                üìä {{ investments|length }} investissement{{ 's' if investments|length != 1 else '' }}
            </div>
        </div>

        <div class="stat-card-mobile">
            <div class="stat-header">
                <div class="stat-icon profits">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">
                        {% set total_earned = 0 %}
                        {% for inv in investments %}
                            {% set total_earned = total_earned + (inv.total_earned or 0) %}
                        {% endfor %}
                        {{ "%.2f"|format(total_earned) }}
                    </div>
                    <div class="stat-label">USDT gagn√©s</div>
                </div>
            </div>
            <div class="stat-indicator positive">
                üöÄ Gains cumul√©s
            </div>
        </div>
    </div>

    <!-- Zone de notifications -->
    <div id="notificationsContainer" class="notifications-container fade-in">
        <!-- Les notifications appara√Ætront ici -->
    </div>

    <!-- Actions rapides -->
    <div class="actions-section fade-in">
        <h2 class="section-title">
            <i class="fas fa-bolt"></i>
            Actions rapides
        </h2>
        
        <div class="actions-grid">
            <button onclick="showDepositModal()" class="action-button">
                <div class="action-content">
                    <div class="action-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="action-text">
                        <div class="action-title">D√©poser</div>
                        <div class="action-subtitle">Ajouter des fonds</div>
                    </div>
                </div>
                <div class="action-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </button>

            <button onclick="showWithdrawModal()" class="action-button withdraw">
                <div class="action-content">
                    <div class="action-icon">
                        <i class="fas fa-hand-holding-dollar"></i>
                    </div>
                    <div class="action-text">
                        <div class="action-title">Retirer</div>
                        <div class="action-subtitle">R√©cup√©rer vos gains</div>
                    </div>
                </div>
                <div class="action-arrow">
                    <i class="fas fa-arrow-right"></i>
                </div>
            </button>
        </div>
    </div>

    <!-- Investissements actifs -->
    <div class="investments-section fade-in">
        <h2 class="section-title">
            <i class="fas fa-chart-line"></i>
            Tes investissements
        </h2>

        {% if investments %}
            {% for investment in investments %}
            <div class="investment-card" data-investment-id="{{ investment.id }}">
                <div class="investment-header">
                    <div>
                        <div class="investment-title">{{ investment.plan_name }}</div>
                        <div class="investment-amount">{{ "%.2f"|format(investment.amount) }} USDT investis</div>
                    </div>
                    <span class="status-badge {{ 'active' if investment.is_active else 'completed' }}">
                        {{ 'Actif' if investment.is_active else 'Termin√©' }}
                    </span>
                </div>

                <div class="investment-stats">
                    <div class="investment-stat">
                        <div class="investment-stat-label">Profit quotidien</div>
                        <div class="investment-stat-value profit">{{ "%.2f"|format(investment.daily_profit) }}</div>
                    </div>
                    <div class="investment-stat">
                        <div class="investment-stat-label">Total gagn√©</div>
                        <div class="investment-stat-value earnings realtime-earnings"
                             data-base-earned="{{ investment.total_earned or 0 }}"
                             data-daily-profit="{{ investment.daily_profit }}"
                             data-start-date="{{ investment.start_date }}"
                             data-is-active="{{ investment.is_active }}">
                            {{ "%.2f"|format(investment.total_earned) }}
                        </div>
                    </div>
                    <div class="investment-stat">
                        <div class="investment-stat-label">Rendement</div>
                        <div class="investment-stat-value">
                            {% if investment.amount and investment.amount > 0 %}
                                {{ "%.1f"|format((investment.total_earned or 0) / investment.amount * 100) }}%
                            {% else %}
                                0%
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if investment.is_active %}
                <div class="live-earnings-indicator">
                    <div class="live-earnings-text">
                        üí∞ <span class="live-earnings" data-investment-id="{{ investment.id }}">Gains en temps r√©el...</span>
                    </div>
                </div>
                {% endif %}

                <div class="investment-footer">
                    <div class="investment-date">
                        ‚è∞ Fin: {% if investment.end_date %}
                            {% if investment.end_date is string %}
                                {{ investment.end_date[:10] | replace('-', '/') }}
                            {% else %}
                                {{ investment.end_date.strftime('%d/%m/%Y') }}
                            {% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="empty-title">Aucun investissement actif</h3>
                <p class="empty-description">
                    Commence ton aventure crypto d√®s maintenant et d√©couvre nos plans d'investissement s√©curis√©s !
                </p>
                <div class="empty-actions">
                    <a href="{{ url_for('staking_plans') }}" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        D√©couvrir nos plans
                    </a>
                    <button onclick="recalculateProfits()" class="btn-secondary">
                        <i class="fas fa-sync"></i>
                        Actualiser
                    </button>
                    <button onclick="restoreInvestments()" class="btn-warning">
                        <i class="fas fa-history"></i>
                        Restaurer
                    </button>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal de d√©p√¥t -->
<div id="depositModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üí∞ D√©poser des fonds</h3>
            <button onclick="hideDepositModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="info-box warning">
            <div class="flex items-start">
                <i class="fas fa-info-circle mr-3 mt-1"></i>
                <div>
                    <strong>Adresse de d√©p√¥t USDT (TRC20):</strong><br>
                    <div class="deposit-address mt-2" onclick="copyDepositAddress()">
                        TAB1oeEKDS5NATwFAaUrTioDU9djX7anyS
                    </div>
                    <button onclick="copyDepositAddress()" class="copy-button">
                        <i class="fas fa-copy mr-1"></i>Copier l'adresse
                    </button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">üíµ Montant √† d√©poser</label>
            <input type="number" id="depositAmount" class="form-input" placeholder="Montant en USDT" min="10">
        </div>

        <div class="form-group">
            <label class="form-label">üîó Hash de transaction</label>
            <input type="text" id="transactionHash" class="form-input" placeholder="Hash de la transaction">
        </div>

        <button onclick="submitDeposit()" class="btn-primary w-full">
            <i class="fas fa-check"></i>
            Confirmer le d√©p√¥t
        </button>
    </div>
</div>

<!-- Modal de retrait -->
<div id="withdrawModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">üí∏ Retirer des fonds</h3>
            <button onclick="hideWithdrawModal()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="info-box info">
            <div class="flex items-center">
                <i class="fas fa-wallet mr-3"></i>
                <div>
                    <strong>Solde disponible:</strong> {{ "%.2f"|format(user.balance) }} USDT<br>
                    <span class="text-sm">Minimum de retrait: 10 USDT</span>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">üìç Adresse de destination (USDT TRC20)</label>
            <input type="text" id="withdrawAddress" class="form-input" placeholder="Votre adresse USDT TRC20">
        </div>

        <div class="form-group">
            <label class="form-label">üí∞ Montant √† retirer</label>
            <input type="number" id="withdrawAmount" class="form-input" placeholder="Montant en USDT" min="10" max="{{ user.balance }}">
        </div>

        <div class="info-box info">
            <div class="text-sm">
                <div class="flex justify-between"><span>Frais de r√©seau:</span><span>2 USDT</span></div>
                <div class="flex justify-between mt-1 font-bold"><span>Montant re√ßu:</span><span id="netAmount">0 USDT</span></div>
            </div>
        </div>

        <button onclick="submitWithdraw()" class="btn-primary w-full">
            <i class="fas fa-paper-plane"></i>
            Confirmer le retrait
        </button>
    </div>
</div>

<script>
// Gestion des modales
function showDepositModal() {
    document.getElementById('depositModal').classList.remove('hidden');
}

function hideDepositModal() {
    document.getElementById('depositModal').classList.add('hidden');
}

function showWithdrawModal() {
    document.getElementById('withdrawModal').classList.remove('hidden');
}

function hideWithdrawModal() {
    document.getElementById('withdrawModal').classList.add('hidden');
}

// Copier l'adresse de d√©p√¥t
function copyDepositAddress() {
    const address = 'TAB1oeEKDS5NATwFAaUrTioDU9djX7anyS';
    navigator.clipboard.writeText(address).then(() => {
        showNotification('‚úÖ Adresse copi√©e!', 'success');
    }).catch(() => {
        const tempInput = document.createElement('input');
        tempInput.value = address;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showNotification('‚úÖ Adresse copi√©e!', 'success');
    });
}

// Soumettre un d√©p√¥t
async function submitDeposit() {
    const amount = document.getElementById('depositAmount').value;
    const hash = document.getElementById('transactionHash').value;

    if (!amount || !hash) {
        showNotification('‚ùå Veuillez remplir tous les champs', 'error');
        return;
    }

    try {
        const response = await fetch('/deposit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount: parseFloat(amount),
                transaction_hash: hash
            })
        });

        const data = await response.json();

        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            hideDepositModal();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur lors du d√©p√¥t'), 'error');
        }
    } catch (error) {
        showNotification('‚ùå Erreur de connexion', 'error');
    }
}

// Soumettre un retrait
async function submitWithdraw() {
    const address = document.getElementById('withdrawAddress').value;
    const amount = parseFloat(document.getElementById('withdrawAmount').value);

    if (!address || !amount) {
        showNotification('‚ùå Veuillez remplir tous les champs', 'error');
        return;
    }

    if (amount < 10) {
        showNotification('‚ùå Le montant minimum de retrait est de 10 USDT', 'error');
        return;
    }

    try {
        const response = await fetch('/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount: amount,
                withdrawal_address: address
            })
        });

        const data = await response.json();

        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            hideWithdrawModal();
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur lors du retrait'), 'error');
        }
    } catch (error) {
        showNotification('‚ùå Erreur de connexion', 'error');
    }
}

// Calculer le montant net pour les retraits
document.getElementById('withdrawAmount')?.addEventListener('input', function() {
    const amount = parseFloat(this.value) || 0;
    const fee = 2;
    const netAmount = Math.max(0, amount - fee);
    document.getElementById('netAmount').textContent = netAmount.toFixed(2) + ' USDT';
});

// Restaurer les investissements
async function restoreInvestments() {
    if (!confirm('‚ö†Ô∏è Cette action va restaurer vos investissements perdus. √ätes-vous s√ªr de vouloir continuer ?')) {
        return;
    }

    try {
        const response = await fetch('/restore-investments', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur lors de la restauration'), 'error');
        }
    } catch (error) {
        showNotification('‚ùå Erreur de connexion', 'error');
    }
}

// Recalculer les profits
async function recalculateProfits() {
    try {
        showNotification('üîÑ Recalcul de vos profits en cours...', 'info');

        const response = await fetch('/calculate-profits-now', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');
            setTimeout(() => window.location.reload(), 2000);
        } else {
            showNotification('‚ùå ' + (data.error || 'Erreur lors du recalcul'), 'error');
        }
    } catch (error) {
        showNotification('‚ùå Erreur de connexion', 'error');
    }
}

// Syst√®me de notifications mobile am√©lior√©
function showNotification(message, type = 'info', duration = 5000) {
    const container = document.getElementById('notificationsContainer');
    if (!container) return;

    const notification = document.createElement('div');
    notification.className = `notification-mobile ${type}`;

    const iconMap = {
        success: 'fas fa-check',
        error: 'fas fa-times',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };

    const titleMap = {
        success: 'Succ√®s',
        error: 'Erreur',
        warning: 'Attention',
        info: 'Information'
    };

    notification.innerHTML = `
        <div class="notification-icon ${type}">
            <i class="${iconMap[type] || iconMap.info}"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title">${titleMap[type] || 'Notification'}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="removeNotification(this.parentElement)">
            <i class="fas fa-times"></i>
        </button>
        <div class="notification-progress"></div>
    `;

    container.appendChild(notification);

    // Animation d'entr√©e
    setTimeout(() => {
        notification.style.animation = 'slideInDown 0.4s ease-out';
    }, 10);

    // Suppression automatique
    setTimeout(() => {
        removeNotification(notification);
    }, duration);

    // Limiter le nombre de notifications affich√©es
    const notifications = container.querySelectorAll('.notification-mobile');
    if (notifications.length > 3) {
        removeNotification(notifications[0]);
    }
}

function removeNotification(notification) {
    if (!notification || !notification.parentNode) return;
    
    notification.style.animation = 'slideOutUp 0.3s ease-in forwards';
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 300);
}

// Syst√®me de gains en temps r√©el
class RealTimeEarnings {
    constructor() {
        this.investments = new Map();
        this.startTimes = new Map();
        this.updateInterval = 1000;
        this.init();
    }

    init() {
        document.querySelectorAll('.realtime-earnings[data-is-active="True"]').forEach(element => {
            const investmentId = element.closest('[data-investment-id]')?.getAttribute('data-investment-id');
            const baseEarned = parseFloat(element.getAttribute('data-base-earned')) || 0;
            const dailyProfit = parseFloat(element.getAttribute('data-daily-profit')) || 0;
            const startDate = element.getAttribute('data-start-date');

            if (investmentId && dailyProfit > 0) {
                const start = new Date(startDate);
                const now = new Date();
                const elapsed = Math.max(0, now.getTime() - start.getTime());

                this.investments.set(investmentId, {
                    element: element,
                    baseEarned: baseEarned,
                    dailyProfit: dailyProfit,
                    profitPerSecond: dailyProfit / (24 * 60 * 60)
                });

                this.startTimes.set(investmentId, Date.now() - elapsed);
            }
        });

        if (this.investments.size > 0) {
            this.startUpdating();
        }
    }

    startUpdating() {
        this.updateTimer = setInterval(() => {
            this.updateEarnings();
        }, this.updateInterval);
        this.updateEarnings();
    }

    updateEarnings() {
        const now = Date.now();
        let totalNewEarnings = 0;

        this.investments.forEach((investment, investmentId) => {
            const elapsed = now - this.startTimes.get(investmentId);
            const elapsedSeconds = elapsed / 1000;
            const newEarnings = elapsedSeconds * investment.profitPerSecond;
            const totalEarnings = investment.baseEarned + newEarnings;

            investment.element.textContent = totalEarnings.toFixed(6);

            const liveElement = document.querySelector(`.live-earnings[data-investment-id="${investmentId}"]`);
            if (liveElement) {
                liveElement.textContent = `+${newEarnings.toFixed(6)} USDT`;
            }

            totalNewEarnings += newEarnings;
        });

        this.updateMainBalance(totalNewEarnings);
    }

    updateMainBalance(totalNewEarnings) {
        const balanceElement = document.getElementById('main-balance');
        const indicatorElement = document.getElementById('balance-indicator');

        if (balanceElement) {
            const baseBalance = parseFloat(balanceElement.getAttribute('data-base-balance')) || 0;
            const newBalance = baseBalance + totalNewEarnings;
            balanceElement.textContent = newBalance.toFixed(6);

            if (indicatorElement && totalNewEarnings > 0) {
                indicatorElement.innerHTML = `<span class="text-green-500">üìà +${totalNewEarnings.toFixed(6)}</span>`;
            }
        }
    }

    stop() {
        if (this.updateTimer) {
            clearInterval(this.updateTimer);
        }
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    const activeInvestments = document.querySelectorAll('.realtime-earnings[data-is-active="True"]');

    if (activeInvestments.length > 0) {
        console.log(`üöÄ D√©marrage du syst√®me de gains en temps r√©el pour ${activeInvestments.length} investissement(s)`);
        window.realTimeEarnings = new RealTimeEarnings();
        showNotification(`üí∞ Gains en temps r√©el activ√©s pour ${activeInvestments.length} plan(s) !`, 'success');
    } else {
        console.log('‚ÑπÔ∏è Aucun investissement actif trouv√© - gains en temps r√©el d√©sactiv√©s');
    }

    // Animation d'apparition
    setTimeout(() => {
        document.querySelectorAll('.fade-in').forEach((el, index) => {
            setTimeout(() => {
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, index * 100);
        });
    }, 100);
});

// Fermer les modales avec √âchap
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        hideDepositModal();
        hideWithdrawModal();
    }
});

// Fermer les modales en cliquant √† l'ext√©rieur
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        hideDepositModal();
        hideWithdrawModal();
    }
});

// Nettoyer lors du changement de page
window.addEventListener('beforeunload', function() {
    if (window.realTimeEarnings) {
        window.realTimeEarnings.stop();
    }
});
</script>
{% endblock %}
