
{% extends "base.html" %}

{% block title %}Admin Dashboard - InvestCrypto Pro{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Header Mobile Optimisé -->
    <div class="admin-header">
        <div class="admin-header-content">
            <div class="admin-title-section">
                <h1 class="admin-title">
                    <i class="fas fa-shield-alt"></i>
                    Administration
                </h1>
                <p class="admin-subtitle">Gestion de la plateforme</p>
            </div>
            <div class="admin-header-actions">
                <button onclick="refreshData()" class="admin-btn-refresh">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button onclick="showQuickActions()" class="admin-btn-menu">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards Grid Mobile -->
    <div class="admin-stats-grid">
        <div class="admin-stat-card users">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.total_users }}</div>
                <div class="stat-label">Utilisateurs</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    +12%
                </div>
            </div>
        </div>

        <div class="admin-stat-card investments">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">${{ "%.0f"|format(stats.total_investments) }}</div>
                <div class="stat-label">Investissements</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    +8%
                </div>
            </div>
        </div>

        <div class="admin-stat-card projects">
            <div class="stat-icon">
                <i class="fas fa-rocket"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.total_projects }}</div>
                <div class="stat-label">Projets</div>
                <div class="stat-change neutral">
                    <i class="fas fa-minus"></i>
                    0%
                </div>
            </div>
        </div>

        <div class="admin-stat-card kyc">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ stats.pending_kyc }}</div>
                <div class="stat-label">KYC Pending</div>
                <div class="stat-change warning">
                    <i class="fas fa-clock"></i>
                    {{ stats.pending_kyc }}
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Rapides Mobile -->
    <div class="admin-quick-actions">
        <h2 class="section-title">
            <i class="fas fa-bolt"></i>
            Actions Rapides
        </h2>
        <div class="quick-actions-grid">
            <a href="{{ url_for('admin_support') }}" class="quick-action-card support">
                <div class="action-icon">
                    <i class="fas fa-headset"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">Support</div>
                    <div class="action-subtitle">{{ stats.open_tickets }} tickets ouverts</div>
                </div>
                <div class="action-arrow">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </a>

            <a href="{{ url_for('admin_transactions') }}" class="quick-action-card transactions">
                <div class="action-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">Transactions</div>
                    <div class="action-subtitle">Gérer dépôts/retraits</div>
                </div>
                <div class="action-arrow">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </a>

            <button onclick="calculateProfits()" class="quick-action-card profits">
                <div class="action-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">Calculer Profits</div>
                    <div class="action-subtitle">Distribution quotidienne</div>
                </div>
                <div class="action-arrow">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </button>

            <button onclick="sendNotification()" class="quick-action-card notifications">
                <div class="action-icon">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="action-content">
                    <div class="action-title">Notifications</div>
                    <div class="action-subtitle">Envoyer message global</div>
                </div>
                <div class="action-arrow">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </button>
        </div>
    </div>

    <!-- Transactions Récentes Mobile -->
    <div class="admin-recent-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-history"></i>
                Activité Récente
            </h2>
            <button onclick="viewAllTransactions()" class="view-all-btn">
                Tout voir
                <i class="fas fa-external-link-alt"></i>
            </button>
        </div>

        {% if transactions %}
        <div class="transactions-mobile-list">
            {% for transaction in transactions[:5] %}
            <div class="transaction-item">
                <div class="transaction-user">
                    <div class="user-avatar">
                        {{ transaction.first_name[0] }}{{ transaction.last_name[0] }}
                    </div>
                    <div class="user-info">
                        <div class="user-name">{{ transaction.first_name }} {{ transaction.last_name }}</div>
                        <div class="user-email">{{ transaction.email }}</div>
                    </div>
                </div>
                <div class="transaction-details">
                    <div class="transaction-type {{ transaction.type }}">
                        {% if transaction.type == 'deposit' %}
                            <i class="fas fa-arrow-down"></i>
                            Dépôt
                        {% else %}
                            <i class="fas fa-arrow-up"></i>
                            Retrait
                        {% endif %}
                    </div>
                    <div class="transaction-amount">
                        ${{ "%.2f"|format(transaction.amount) }}
                    </div>
                    <div class="transaction-status {{ transaction.status }}">
                        {{ transaction.status.title() }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-chart-line"></i>
            <p>Aucune transaction récente</p>
        </div>
        {% endif %}
    </div>

    <!-- Gestion Système Mobile -->
    <div class="admin-system-section">
        <h2 class="section-title">
            <i class="fas fa-cogs"></i>
            Gestion Système
        </h2>
        <div class="system-actions">
            <button onclick="exportData()" class="system-btn export">
                <i class="fas fa-download"></i>
                <span>Export Données</span>
            </button>
            <button onclick="backupDatabase()" class="system-btn backup">
                <i class="fas fa-database"></i>
                <span>Sauvegarde</span>
            </button>
            <button onclick="viewLogs()" class="system-btn logs">
                <i class="fas fa-file-alt"></i>
                <span>Logs Système</span>
            </button>
            <button onclick="deactivateAdmin()" class="system-btn security">
                <i class="fas fa-shield-alt"></i>
                <span>Sécurité</span>
            </button>
        </div>
    </div>
</div>

<!-- Modal Actions Rapides -->
<div id="quickActionsModal" class="admin-modal">
    <div class="modal-overlay" onclick="hideQuickActions()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Actions Rapides</h3>
            <button onclick="hideQuickActions()" class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-actions">
            <button onclick="calculateProfits()" class="modal-action">
                <i class="fas fa-calculator"></i>
                Calculer Profits
            </button>
            <button onclick="sendGlobalNotification()" class="modal-action">
                <i class="fas fa-bullhorn"></i>
                Notification Globale
            </button>
            <button onclick="exportAllData()" class="modal-action">
                <i class="fas fa-download"></i>
                Export Complet
            </button>
            <button onclick="deactivateAdmin()" class="modal-action danger">
                <i class="fas fa-power-off"></i>
                Désactiver Admin
            </button>
        </div>
    </div>
</div>

<style>
/* Admin Container */
.admin-container {
    max-width: 100vw;
    padding: 1rem;
    background: #f8fafc;
    min-height: 100vh;
}

/* Header Mobile */
.admin-header {
    background: linear-gradient(135deg, #1e293b, #334155);
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    color: white;
    box-shadow: 0 10px 30px rgba(30, 41, 59, 0.3);
}

.admin-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.admin-subtitle {
    font-size: 0.9rem;
    opacity: 0.8;
    margin: 0.25rem 0 0 0;
}

.admin-header-actions {
    display: flex;
    gap: 0.5rem;
}

.admin-btn-refresh,
.admin-btn-menu {
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.admin-btn-refresh:hover,
.admin-btn-menu:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
}

/* Stats Grid Mobile */
.admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.admin-stat-card {
    background: white;
    border-radius: 16px;
    padding: 1.25rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid #f1f5f9;
    transition: all 0.3s ease;
}

.admin-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    margin-bottom: 0.75rem;
}

.admin-stat-card.users .stat-icon {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

.admin-stat-card.investments .stat-icon {
    background: linear-gradient(135deg, #10b981, #059669);
}

.admin-stat-card.projects .stat-icon {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.admin-stat-card.kyc .stat-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.stat-change {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.stat-change.positive {
    background: #dcfce7;
    color: #166534;
}

.stat-change.warning {
    background: #fef3c7;
    color: #92400e;
}

.stat-change.neutral {
    background: #f3f4f6;
    color: #6b7280;
}

/* Actions Rapides */
.admin-quick-actions {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.quick-actions-grid {
    display: grid;
    gap: 0.75rem;
}

.quick-action-card {
    background: white;
    border-radius: 16px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-decoration: none;
    color: inherit;
    border: 1px solid #f1f5f9;
    transition: all 0.3s ease;
    cursor: pointer;
    border: none;
    width: 100%;
    text-align: left;
}

.quick-action-card:hover {
    transform: translateX(4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.action-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: white;
    flex-shrink: 0;
}

.quick-action-card.support .action-icon {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.quick-action-card.transactions .action-icon {
    background: linear-gradient(135deg, #10b981, #059669);
}

.quick-action-card.profits .action-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.quick-action-card.notifications .action-icon {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.action-content {
    flex: 1;
}

.action-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.action-subtitle {
    font-size: 0.8rem;
    color: #6b7280;
}

.action-arrow {
    color: #9ca3af;
    font-size: 0.9rem;
}

/* Section Récente */
.admin-recent-section {
    background: white;
    border-radius: 16px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid #f1f5f9;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.view-all-btn {
    background: none;
    border: none;
    color: #3b82f6;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.transactions-mobile-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.transaction-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 12px;
}

.transaction-user {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
}

.user-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
}

.user-email {
    font-size: 0.75rem;
    color: #6b7280;
}

.transaction-details {
    text-align: right;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.transaction-type {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.transaction-type.deposit {
    background: #dcfce7;
    color: #166534;
}

.transaction-type.withdrawal {
    background: #fee2e2;
    color: #dc2626;
}

.transaction-amount {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
}

.transaction-status {
    font-size: 0.7rem;
    text-transform: capitalize;
    color: #6b7280;
}

/* Système */
.admin-system-section {
    background: white;
    border-radius: 16px;
    padding: 1.25rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid #f1f5f9;
}

.system-actions {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.system-btn {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-align: center;
}

.system-btn:hover {
    background: #f1f5f9;
    transform: translateY(-1px);
}

.system-btn.security {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    border-color: #fca5a5;
    color: #dc2626;
}

.system-btn i {
    font-size: 1.25rem;
}

.system-btn span {
    font-size: 0.8rem;
    font-weight: 500;
}

/* Modal */
.admin-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
}

.admin-modal.active {
    display: flex;
    align-items: flex-end;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal-content {
    background: white;
    border-radius: 20px 20px 0 0;
    padding: 1.5rem;
    width: 100%;
    max-width: 400px;
    position: relative;
    max-height: 50vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #6b7280;
    cursor: pointer;
}

.modal-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.modal-action {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 500;
}

.modal-action:hover {
    background: #f1f5f9;
}

.modal-action.danger {
    background: #fee2e2;
    border-color: #fca5a5;
    color: #dc2626;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Responsive */
@media (min-width: 768px) {
    .admin-container {
        padding: 2rem;
    }
    
    .admin-stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .system-actions {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .modal-content {
        border-radius: 20px;
        max-height: 70vh;
        margin: 2rem;
    }
    
    .admin-modal.active {
        align-items: center;
    }
}
</style>

<script>
function refreshData() {
    location.reload();
}

function showQuickActions() {
    document.getElementById('quickActionsModal').classList.add('active');
}

function hideQuickActions() {
    document.getElementById('quickActionsModal').classList.remove('active');
}

function calculateProfits() {
    if (confirm('Lancer le calcul des profits quotidiens ?')) {
        fetch('/admin/calculate-profits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Calcul des profits lancé!', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification(data.error || 'Erreur', 'error');
            }
        })
        .catch(error => showNotification('Erreur de connexion', 'error'));
    }
}

function deactivateAdmin() {
    if (confirm('Désactiver l\'accès administrateur ?')) {
        fetch('/admin/deactivate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Admin désactivé', 'success');
                setTimeout(() => window.location.href = '/dashboard', 1500);
            } else {
                showNotification(data.error || 'Erreur', 'error');
            }
        })
        .catch(error => showNotification('Erreur de connexion', 'error'));
    }
}

function sendNotification() {
    const message = prompt('Message à envoyer à tous les utilisateurs:');
    if (message && message.trim()) {
        // Implementation for global notification
        showNotification('Fonctionnalité bientôt disponible', 'info');
    }
}

function exportData() {
    showNotification('Export en cours...', 'info');
    // Implementation for data export
}

function backupDatabase() {
    showNotification('Sauvegarde en cours...', 'info');
    // Implementation for database backup
}

function viewLogs() {
    showNotification('Ouverture des logs...', 'info');
    // Implementation for viewing logs
}

function viewAllTransactions() {
    window.location.href = '{{ url_for("admin_transactions") }}';
}

// Auto-refresh every 5 minutes
setInterval(refreshData, 300000);
</script>
{% endblock %}
